#!/bin/bash
#SBATCH --job-name=%DETECTOR_VERSION%/%DETECTOR_CONFIG%/%CSV_FILE%
#SBATCH --error=LOG/SLURM/grex_%A/grex_%A_%4a.err
#SBATCH --output=LOG/SLURM/grex_%A/grex_%A_%4a.out
#SBATCH --mail-type=FAIL,TIME_LIMIT,TIME_LIMIT_90
#SBATCH --cpus-per-task=1
#SBATCH --mem=3G
#SBATCH --time=24:00:00

# Load singularity module
module load singularity

# Get CSV_FILE entry $a
mapfile array < %CSV_FILE%
IFS=, read file ext nevents ichunk <<< ${array[${SLURM_ARRAY_TASK_ID}]}

# Start singularity instance
SingularityImage="/cvmfs/singularity.opensciencegrid.org/eicweb/eic_xl:%JUG_XL_TAG%"
instance=${SLURM_ARRAY_JOB_ID}_${SLURM_ARRAY_TASK_ID}
singularity instance start --bind /cvmfs --bind $(realpath $PWD) ${SingularityImage} ${instance}

# Create aliases for condor syntax
set -a # export the following funcs
file()    { echo $file; }
ext()     { echo $ext; }
nevents() { echo $nevents; }
ichunk()  { echo $ichunk; }
set +a # stop exporting

# Run command
singularity exec instance://${instance} /bin/bash << EOF
cd $(realpath $PWD)
source $(basename $0 .submit).sh
%EXECUTABLE% %ARGUMENTS%
EOF

# Stop singularity instance
singularity instance stop ${instance}
